<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Progress Dashboard - Fitness Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg-image: url("/img/background.jpg");
      --bg-base:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --accent:#3b82f6; --accent-2:#22c55e; --danger:#ef4444;
      --border:rgba(148,163,184,.16); --chip:#1e293b;
      --glass: rgba(2,6,23,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        var(--bg-image) center/cover no-repeat fixed,
        var(--bg-base);
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 20px;border-bottom:1px solid var(--border);
      background:var(--glass); backdrop-filter: blur(6px);
      position:sticky;top:0;z-index:100; box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    .pill{padding:6px 10px;border-radius:999px;background:#0b3b70;color:#cfe1ff;border:1px solid #1d4ed8;}
    .logout{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:8px 14px;cursor:pointer}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:2fr 1.4fr;gap:18px}
    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.96), rgba(9,15,28,.98));
      border:1px solid var(--border);border-radius:16px;padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    h2{margin:0 0 10px;font-size:16px;letter-spacing:.2px}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Progress Dashboard</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="userBadge" class="pill">User</span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="small" id="goalLine" style="margin-bottom:10px;"></div>

    <div class="grid">
      <section class="card">
        <h2>Calories (Last 7 Days)</h2>
        <p class="small">Target vs consumed vs burned. Days with no logs show as zero.</p>
        <canvas id="calorieChart" height="140"></canvas>
      </section>

      <section class="card">
        <h2>Workout Frequency by Muscle Group</h2>
        <p class="small">Number of workouts involving each muscle group in the last 7 days.</p>
        <canvas id="muscleChart" height="140"></canvas>
      </section>
    </div>

    <div style="margin-top:18px">
      <section class="card">
        <h2>Macronutrient Intake (Last 7 Days)</h2>
        <p class="small">Protein, carbs, and fats consumed each day.</p>
        <canvas id="macroChart" height="160"></canvas>
      </section>
    </div>
  </div>

  <script>
    // --- session ---
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user) location.href = '/login.html';
    document.getElementById('userBadge').textContent = `Hi, ${user.name || 'User'}`;

    function logout(){
      localStorage.removeItem('user');
      location.href = '/login.html';
    }

    const fmtDateShort = iso => {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return `${d.getMonth()+1}/${d.getDate()}`; // M/D
    };

    async function loadProgress(){
    try{
      const res = await fetch(`/api/progress/weekly/${user.userId}`, { cache:'no-store' });

      if (!res.ok){
        const text = await res.text();   // read whatever backend returned
        alert(`Failed to load progress data.\nStatus: ${res.status}\nBody: ${text.substring(0,300)}`);
        return;
      }

      const data = await res.json();
      renderProgress(data);
    }catch(e){
      console.error(e);
      alert('Failed to load progress data (network error in fetch)');
    }
  }

    function renderProgress(data){
      if (data.goalType){
        document.getElementById('goalLine').textContent =
          `Current goal: ${data.goalType}`;
      }

      const days = data.days || [];
      const labels   = days.map(d => fmtDateShort(d.date));
      const target   = days.map(d => d.targetCalories || 0);
      const consumed = days.map(d => d.consumedCalories || 0);
      const burned   = days.map(d => d.burnedCalories || 0);

      const prot = days.map(d => d.consumedProtein || 0);
      const carb = days.map(d => d.consumedCarb || 0);
      const fat  = days.map(d => d.consumedFat || 0);

      const mgLabels = (data.muscleGroups || []).map(m => m.muscleGroup);
      const mgValues = (data.muscleGroups || []).map(m => m.sessions);

      // --- Calories chart ---
      const ctxCal = document.getElementById('calorieChart').getContext('2d');
      new Chart(ctxCal, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Target kcal',
              data: target,
              borderColor: '#64748b',
              backgroundColor: 'rgba(148,163,184,0.15)',
              tension: 0.3
            },
            {
              label: 'Consumed',
              data: consumed,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59,130,246,0.25)',
              tension: 0.3,
              fill: true
            },
            {
              label: 'Burned',
              data: burned,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34,197,94,0.25)',
              tension: 0.3
            }
          ]
        },
        options: {
          responsive:true,
          plugins:{
            legend:{labels:{color:'#e2e8f0'}},
          },
          scales:{
            x:{ticks:{color:'#cbd5e1'},grid:{color:'rgba(15,23,42,0.6)'}},
            y:{ticks:{color:'#cbd5e1'},grid:{color:'rgba(15,23,42,0.6)'}}
          }
        }
      });

      // --- Macro chart (stacked bar) ---
      const ctxMacro = document.getElementById('macroChart').getContext('2d');
      new Chart(ctxMacro, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label:'Protein (g)', data: prot, backgroundColor:'#22c55e' },
            { label:'Carbs (g)',   data: carb, backgroundColor:'#3b82f6' },
            { label:'Fat (g)',     data: fat,  backgroundColor:'#f97316' }
          ]
        },
        options: {
          responsive:true,
          plugins:{ legend:{labels:{color:'#e2e8f0'}} },
          scales:{
            x:{stacked:true,ticks:{color:'#cbd5e1'},grid:{color:'rgba(15,23,42,0.6)'}},
            y:{stacked:true,ticks:{color:'#cbd5e1'},grid:{color:'rgba(15,23,42,0.6)'}}
          }
        }
      });

      // --- Muscle group chart ---
      const ctxMuscle = document.getElementById('muscleChart').getContext('2d');
      new Chart(ctxMuscle, {
        type: 'bar',
        data: {
          labels: mgLabels,
          datasets: [
            {
              label: 'Sessions',
              data: mgValues,
              backgroundColor: '#a855f7'
            }
          ]
        },
        options: {
          responsive:true,
          plugins:{ legend:{labels:{color:'#e2e8f0'}} },
          scales:{
            x:{ticks:{color:'#cbd5e1'},grid:{display:false}},
            y:{ticks:{color:'#cbd5e1'},grid:{color:'rgba(15,23,42,0.6)'}}
          }
        }
      });
    }

    loadProgress();
  </script>
</body>
</html>
